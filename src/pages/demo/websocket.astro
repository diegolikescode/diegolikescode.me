---
import Layout from '@layouts/Layout.astro'
import Container from '@components/container.astro'
import Sectionhead from '@components/sectionhead.astro'
import Button from '@components/ui/button.astro'
---

<Layout title="Websocket">
    <Container>
        <Sectionhead>
            <Fragment slot="title">Websocket multiplayer game demo</Fragment>
            <Fragment slot="desc">
                A simple game to showcase the use of native Websockets in NodeJS
            </Fragment>
        </Sectionhead>
        <main class="mt-16">
            <h1 id="clientId"></h1>
            <h1 id="gameId">press "new game" to get your game ID or Join someone else's game with "Join Game"</h1>
            <div class="flex gap-2">
                <input type="text" placeholder="Your game ID" id="inputGameId" class="rounded-md"/>
                <Button id="joinGameBtn" class='rounded-md'>Join Game</Button>
            </div>
            <Button id="newGame">New Game</Button>
            <Button id="exitGame">Exit Game</Button>
        </main>
    </Container>
</Layout>

<script>
    let clientId = null
    let gameId = null
    const ws = new WebSocket('ws://localhost:6969')
    document.getElementById('newGame')?.addEventListener('click', (e) => {
        const payload = {
            method: 'create',
            clientId: clientId,
        }

        ws.send(JSON.stringify(payload))
    })

    document.getElementById('joinGameBtn')?.addEventListener('click', e => {
        gameId = document.getElementById('inputGameId')?.value || ''
        if (gameId === null) {
            return
        }

        const payload = {
            method: 'join',
            gameId,
            clientId,
        }

        ws.send(JSON.stringify(payload))
    })

    ws.onmessage = (msg) => {
        const res = JSON.parse(msg.data)
        if (res.method === 'connect') {
            clientId = res.clientId
            const h1ClientId = document.getElementById('clientId')
            if (h1ClientId !== null) {
                const phraseClient =
                    clientId !== null
                        ? `your client ID is: ${clientId}`
                        : 'press "new game" to get your client ID'
                h1ClientId.innerHTML = phraseClient
            }
        }

        if (res.method === 'create') {
            const h1GameId = document.getElementById('gameId')
            gameId = res.game.id
            console.log(res)
            if (h1GameId !== null) {
                const phraseGame =
                    gameId !== null
                        ? `your game ID is: ${gameId}`
                        : 'press "new game" to get your game ID'
                h1GameId.innerHTML = phraseGame
            }
        }

        if (res.method === 'join') {
            console.log(res)
            // gameId = res.game.id
            // console.log(res)
            // if (h1GameId !== null) {
            //     const phraseGame =
            //         gameId !== null
            //             ? `your game ID is: ${gameId}`
            //             : 'press "new game" to get your game ID'
            //     h1GameId.innerHTML = phraseGame
            // }
        }
    }
</script>
